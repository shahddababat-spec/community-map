<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Community Stories Map</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      direction: rtl;
      padding: 10px;
    }
    #map {
      height: 400px;
      margin-top: 10px;
    }
    input, textarea, select, button {
      width: 100%;
      margin: 5px 0;
      padding: 8px;
    }
  </style>
</head>

<body>

  <!-- ğŸ“ Ø§Ù„ÙÙˆØ±Ù… -->
  <input id="name" placeholder="Ø§Ù„Ø§Ø³Ù…">
  <input id="title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚ØµØ©">
  <textarea id="story" placeholder="Ø§ÙƒØªØ¨ÙŠ Ø§Ù„Ù‚ØµØ©"></textarea>

  <select id="category">
    <option value="Ø°ÙƒØ±Ù‰">Ø°ÙƒØ±Ù‰</option>
    <option value="Ø­ÙƒØ§ÙŠØ©">Ø­ÙƒØ§ÙŠØ©</option>
    <option value="Ø±Ø£ÙŠ">Ø±Ø£ÙŠ</option>
  </select>

  <!-- ğŸ“· Ø±ÙØ¹ ØµÙˆØ±Ø© -->
  <input type="file" id="photo" accept="image/*">

  <button onclick="submitStory()">Ø¥Ø±Ø³Ø§Ù„</button>

  <p id="status"></p>

  <!-- ğŸ—ºï¸ Ø§Ù„Ø®Ø±ÙŠØ·Ø© -->
  <div id="map"></div>

<script>
  // ğŸ”µ Ø§Ù„Ø®Ø±ÙŠØ·Ø© â€“ Ù…Ø®ÙŠÙ… Ø¬Ù†ÙŠÙ†
  const map = L.map('map').setView([32.4603, 35.2956], 15);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap'
  }).addTo(map);

  let selectedLatLng = null;

  map.on('click', function(e) {
    selectedLatLng = e.latlng;
    alert("ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹");
  });

  async function submitStory() {

    if (!selectedLatLng) {
      alert("Ø§Ø®ØªØ§Ø±ÙŠ Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©");
      return;
    }

    const name = document.getElementById("name").value;
    const title = document.getElementById("title").value;
    const story = document.getElementById("story").value;
    const category = document.getElementById("category").value;
    const file = document.getElementById("photo").files[0];

    let photoPayload = null;

    // ğŸ“· Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø©
    if (file) {
      if (file.size > 2 * 1024 * 1024) {
        alert("Ø§Ù„ØµÙˆØ±Ø© Ø£ÙƒØ¨Ø± Ù…Ù† 2MB");
        return;
      }

      const dataUrl = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });

      photoPayload = {
        fileName: file.name,
        dataUrl: dataUrl
      };
    }

    // ğŸš€ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    fetch("https://script.google.com/macros/s/AKfycbyk8zbGnixeXAsexnu3z2BCMdRaUd1QJvN-uBWxEN2jtbbWP65xd6WZQITRCJP1bb_Zpg/exec", {
      method: "POST",
      body: JSON.stringify({
        name,
        title,
        story,
        category,
        lat: selectedLatLng.lat,
        lng: selectedLatLng.lng,
        photo: photoPayload
      })
    })
    .then(res => res.json())
    .then(resp => {

      const imgHtml = resp.photo_url
        ? `<br><img src="${resp.photo_url}" style="max-width:220px;border-radius:10px;margin-top:5px;">`
        : "";

      L.marker(selectedLatLng).addTo(map)
        .bindPopup(`<b>${title}</b><br>${story}${imgHtml}`);

      document.getElementById("status").innerText = "âœ” ØªÙ… Ø§Ù„Ø­ÙØ¸";
    })
    .catch(() => {
      document.getElementById("status").innerText = "âŒ Ø®Ø·Ø£ Ø¨Ø§Ù„Ø¥Ø±Ø³Ø§Ù„";
    });
  }
</script>

</body>
</html>




